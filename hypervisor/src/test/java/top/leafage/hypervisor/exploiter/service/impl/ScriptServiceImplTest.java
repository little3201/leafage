package top.leafage.hypervisor.exploiter.service.impl;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.data.r2dbc.core.R2dbcEntityTemplate;
import org.springframework.data.r2dbc.core.ReactiveSelectOperation;
import org.springframework.data.relational.core.query.Query;
import reactor.core.publisher.Flux;
import reactor.core.publisher.Mono;
import reactor.test.StepVerifier;
import top.leafage.hypervisor.exploiter.domain.Script;
import top.leafage.hypervisor.exploiter.repository.ScriptRepository;

import static org.mockito.ArgumentMatchers.any;
import static org.mockito.ArgumentMatchers.anyLong;
import static org.mockito.BDDMockito.given;
import static org.mockito.Mockito.mock;

/**
 * script service test
 *
 * @author wq li
 */
@ExtendWith(MockitoExtension.class)
class ScriptServiceImplTest {

    @Mock
    private ScriptRepository scriptRepository;

    @InjectMocks
    private ScriptServiceImpl scriptService;

    @Mock
    private R2dbcEntityTemplate r2dbcEntityTemplate;

    private Script entity;

    @BeforeEach
    void setUp() {
        entity = new Script();
        entity.setName("test");
        entity.setType("test");
        entity.setIcon("test");
    }

    @Test
    void retrieve() {
        ReactiveSelectOperation.ReactiveSelect<Script> select = mock(ReactiveSelectOperation.ReactiveSelect.class);
        ReactiveSelectOperation.TerminatingSelect<Script> terminating = mock(ReactiveSelectOperation.TerminatingSelect.class);

        given(r2dbcEntityTemplate.select(Script.class)).willReturn(select);
        given(select.matching(any(Query.class))).willReturn(terminating);
        given(terminating.all()).willReturn(Flux.just(entity));

        StepVerifier.create(scriptService.retrieve("name:like:test")).expectNextCount(1).verifyComplete();
    }

    @Test
    void fetch() {
        given(this.scriptRepository.findById(anyLong())).willReturn(Mono.just(mock(Script.class)));
        StepVerifier.create(scriptService.fetch(anyLong())).expectNextCount(1).verifyComplete();
    }

}
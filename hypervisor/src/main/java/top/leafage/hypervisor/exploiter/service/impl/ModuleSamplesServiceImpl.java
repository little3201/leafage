/*
 * Copyright (c) 2025.  little3201.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *       https://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package top.leafage.hypervisor.exploiter.service.impl;

import jakarta.transaction.Transactional;
import org.springframework.stereotype.Service;
import org.springframework.util.Assert;
import top.leafage.hypervisor.exploiter.domain.ModuleSamples;
import top.leafage.hypervisor.exploiter.repository.ModuleSamplesRepository;
import top.leafage.hypervisor.exploiter.service.ModuleSamplesService;

import java.util.List;
import java.util.Set;

import static top.leafage.common.data.Service._MUST_NOT_BE_EMPTY;
import static top.leafage.common.data.Service._MUST_NOT_BE_NULL;

/**
 * module fragments service impl.
 *
 * @author wq li
 */
@Service
public class ModuleSamplesServiceImpl implements ModuleSamplesService {

    private final ModuleSamplesRepository moduleSamplesRepository;

    public ModuleSamplesServiceImpl(ModuleSamplesRepository moduleSamplesRepository) {
        this.moduleSamplesRepository = moduleSamplesRepository;
    }

    @Override
    public List<ModuleSamples> findAllByModuleId(Long moduleId) {
        return moduleSamplesRepository.findAllByModuleId(moduleId);
    }

    @Transactional
    @Override
    public List<ModuleSamples> relation(Long moduleId, Set<Long> sampleIds) {
        Assert.notNull(moduleId, String.format(_MUST_NOT_BE_NULL, "moduleId"));
        Assert.notNull(sampleIds, String.format(_MUST_NOT_BE_EMPTY, "sampleIds"));

        List<ModuleSamples> sampleModules = sampleIds.stream().map(sampleId -> {
            ModuleSamples sampleModule = new ModuleSamples();
            sampleModule.setModuleId(moduleId);
            sampleModule.setSampleId(sampleId);
            return sampleModule;
        }).toList();
        return moduleSamplesRepository.saveAllAndFlush(sampleModules);
    }

    @Transactional
    @Override
    public void removeRelation(Long moduleId, Set<Long> sampleIds) {
        Assert.notNull(moduleId, String.format(_MUST_NOT_BE_NULL, "moduleId"));
        Assert.notNull(sampleIds, String.format(_MUST_NOT_BE_EMPTY, "sampleIds"));

        List<ModuleSamples> sampleModules = moduleSamplesRepository.findAllByModuleId(moduleId);
        List<Long> filteredIds = sampleModules.stream()
                .filter(moduleFragment -> sampleIds.contains(moduleFragment.getSampleId()))
                .map(ModuleSamples::getId).toList();
        moduleSamplesRepository.deleteAllById(filteredIds);
    }
}
